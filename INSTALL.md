# BLAB Controller - Installation instructions

These instructions assume that BLAB controller is going to be installed at */somewhere/blab-controller* on Linux. Thus,
for example, this file is at */somewhere/blab-controller/INSTALL.md*, and the manage script is at
*/somewhere/blab-controller/blab-controller/manage.py*. Non-absolute directories will be relative to
*/somewhere/blab-controller*.

- Install
  [Python 3.10](https://www.python.org/downloads/release/python-3100/)
  or newer. If it is not available in the
  repositories, [this short script](https://gist.github.com/viniciusbm/f603d2d8165b08321be0728e5e51e8d8) can be used to
  compile and install it from source.

- Install `python3-venv` or the equivalent package for the Linux distribution you are using. It may correspond to a
  different Python version.

- Install [Poetry](https://python-poetry.org/):

  ```shell
  curl -sSL https://install.python-poetry.org | python3 - --preview
  ```
  If *~/.local/bin* is not in `PATH`, add it as suggested by the output of Poetry installer.

- In the root directory of the project (which contains this _INSTALL.md_ file)
  run Poetry to install the dependencies in a new virtual environment (_.venv_):

  ```shell
  POETRY_VIRTUALENVS_IN_PROJECT=true poetry install
  ```

- **(In development and test environments)** <br/>
  To install additional dependencies for development, documentation generation and testing, add the arguments
  `--with dev,doc,test` to the command in the last step. To avoid the installation of production-only dependencies,
  add `--without prod`.

- Install and set up the database server ([PostgreSQL](https://www.postgresql.org/),
  [MariaDB](https://mariadb.org/), [MySQL](https://www.mysql.com/) or [Oracle](https://www.oracle.com/database/)). If
  needed, check
  the [Django documentation on database installation](https://docs.djangoproject.com/en/4.0/ref/databases/). In
  development environments, [SQLite](https://www.sqlite.org/index.html) is also supported.

- **(In production environment)** <br/>
  Create a database to be used by BLAB (e.g. `CREATE DATABASE blab;`) and a database user that can modify it.

- Install the additional Python dependencies that are specific for the database server (for MariaDB, write `MySQL`):

  ```shell
  # Run only the line that corresponds to the database server that will be used.
  poetry install --only=MySQL
  poetry install --only=Oracle
  poetry install --only=PostgreSQL
  poetry install --only=SQLite3
  ```

- Set the following environment variables. This can be done using system tools, cloud server settings [or a secret *
  .env* file](https://github.com/theskumar/python-dotenv) in the same directory as *manage.py*.

    - `DJANGO_SETTINGS_MODULE`: define it as _controller.settings.dev_ or _controller.settings.prod_ (for development
      and production environments, respectively).
    - `SECRET_KEY` **(only needed in production environment)**: define it as an unpredictable 50-character
      cryptographically secure string. It can be generated by running:

        ```shell
        poetry run python -c 'from django.core.management.utils import get_random_secret_key as s; print(s())'
        ```

- **(In production environment)** <br/>
  In *blab-controller/controller/settings/*, create a copy of the file *prod_TEMPLATE.py* and name it *prod.py*. Fill in
  the fields following the instructions on the file and the linked documentation.

- Let Django create the database tables:

  ```shell
  poetry run ./blab-controller/manage.py migrate
  ```

- **(In development environment)** <br/>
  To start the development server, run:

  ```shell
  poetry run ./blab-controller/manage.py runserver
  ```

- **(In production environment)** <br/>
  Follow [Django's instructions](https://docs.djangoproject.com/en/4.0/howto/deployment/) to set up the interaction
  between the web server and the controller written in Python.
  <details>
    <summary>
    Example - using Apache, Gunicorn and Daphne on a Debian-based Linux distribution
    </summary>

    - Install [Gunicorn](https://github.com/benoitc/gunicorn)
      and [Daphne](https://github.com/django/daphne):

      ```shell
      poetry run pip install gunicorn daphne
      ```

    - Create the service files for Gunicorn and Daphne in the directory */etc/systemd/system/*, changing the usernames,
      ports and paths as needed:

        ```ini
        # /etc/systemd/system/blab-gunicorn.service
        [Unit]
        Description=Gunicorn daemon for BLAB
        After=network.target

        [Service]
        User=user_name_here
        Group=www-data
        Restart=always
        WorkingDirectory=/somewhere/blab-controller/blab-controller
        ExecStart=/somewhere/blab-controller/.venv/bin/python -m gunicorn -b 127.0.0.1:25224 controller.wsgi

        [Install]
        WantedBy=multi-user.target
        ```

        ```ini
        # /etc/systemd/system/blab-daphne.service
        [Unit]
        Description=Daphne daemon for BLAB
        After=network.target

        [Service]
        User=user_name_here
        Group=www-data
        Restart=always
        WorkingDirectory=/somewhere/blab-controller/blab-controller
        ExecStart=/somewhere/blab-controller/.venv/bin/python -m daphne -b 127.0.0.1 -p 25223 controller.asgi:application

        [Install]
        WantedBy=multi-user.target
        ```
    - Run `systemctl enable blab-gunicorn blab-daphne` and `systemctl start blab-gunicorn blab-daphne` as root to enable
      the services and start them immediately.
    - Install [Apache HTTP Server](https://httpd.apache.org/) (e.g. `apt install apache2` as root) if it is not
      installed yet.
    - Enable Apache's
      [*mod_proxy_http*](https://httpd.apache.org/docs/2.4/mod/mod_proxy_http.html),
      [*mod_proxy_wstunnel*](https://httpd.apache.org/docs/2.4/mod/mod_proxy_wstunnel.html) and
      [*mod_rewrite*](https://httpd.apache.org/docs/2.4/mod/mod_rewrite.html) modules by
      running `a2enmod proxy_http proxy_wstunnel rewrite` as root.
    - Create the file
      */etc/apache2/sites-available/blab-controller.conf* with the following contents, changing the paths, IPs,
      ports and addresses as needed:

        ```ApacheConf
        # /etc/apache2/sites-available/blab-controller.conf

        Define BLAB_CONTROLLER_ROOT /somewhere/blab-controller
        Define BLAB_CONTROLLER_FE   /path/to/the/front/end/here
        Define BLAB_DAPHNE_PORT 25223
        Define BLAB_GUNICORN_PORT 25224
        Define BLAB_SERVER_NAME www.blab.example.com
        Define BLAB_SERVER_IPS_PORTS '127.0.0.1:80 192.168.122.10:80'

        ErrorLog ${BLAB_CONTROLLER_ROOT}/blab-controller/.logs/error.log
        CustomLog ${BLAB_CONTROLLER_ROOT}/blab-controller/.logs/access.log combined

        <VirtualHost ${BLAB_SERVER_IPS_PORTS}>
          ServerName ${BLAB_SERVER_NAME}

          <Directory "${BLAB_CONTROLLER_FE}">
            Options Indexes FollowSymLinks
            AllowOverride All

            Options -MultiViews
            RewriteEngine On
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^ index.html [QSA,L]

            Require all granted
          </Directory>
          DocumentRoot ${BLAB_CONTROLLER_FE}

          ProxyPass /ws/  "ws://localhost:${BLAB_DAPHNE_PORT}/ws/"
          ProxyPass /static/ !
          ProxyPass /media/ !
          ProxyPass /api/ "http://localhost:${BLAB_GUNICORN_PORT}/api/"

        </VirtualHost>
        ```
    - Run `a2ensite blab-controller` as root to enable the site configuration.

    - Restart Gunicorn and Daphne (`systemctl restart blab-gunicorn blab-daphne`) now and **whenever changes are made**
      to any file in *blab-controller/* and its subdirectories.

    - Restart Apache (`systemctl reload apache2` as root).

    At this point, the installation should be ready.

  </details>
